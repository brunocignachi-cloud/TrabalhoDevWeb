<%- include('partials/header') %>
<main class="container">
  <h2>Lista de Usuários</h2>

  <% if (users && users.length) { %>
    <table border="1" cellpadding="5" cellspacing="0">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Idade</th>
          <th>CPF</th>
          <th>Salário</th>
          <th>Localização</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        <% users.forEach(u => { %>
          <tr>
            <td><%= u.name %></td>
            <td><%= u.age %></td>
            <td><%= u.cpf %></td>
            <td>R$ <%= u.income.toFixed(2) %></td>
            <td><%= u.location %></td>
            <td>
              <div class="dropdown">
                <button class="dropbtn">⋮</button>
                <div class="dropdown-content">
                  <a href="#" onclick="editarCliente('<%= u._id %>')">Editar</a>
                  <a href="#" onclick="excluirCliente('<%= u._id %>')">Excluir</a>
                </div>
              </div>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% } else { %>
    <p>Nenhum usuário encontrado.</p>
  <% } %>

  <p><a href="/">Voltar</a></p>
</main>

<style>
  .dropdown {
    position: relative;
    display: inline-block;
  }
  .dropbtn {
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
  }
  .dropdown-content {
    display: none;
    position: absolute;
    background: #f9f9f9;
    min-width: 120px;
    box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
    z-index: 1;
  }
  .dropdown-content a {
    display: block;
    padding: 8px;
    text-decoration: none;
    color: #333;
  }
  .dropdown-content a:hover {
    background: #ddd;
  }
  .dropdown:hover .dropdown-content {
    display: block;
  }
</style>

<script>
  async function excluirCliente(id) {
    if (confirm("Deseja realmente excluir este cliente?")) {
      const resp = await fetch(`/clientes/${id}`, { method: "DELETE" });
      if (resp.ok) {
        alert("Cliente excluído com sucesso!");
        location.reload();
      } else {
        alert("Erro ao excluir cliente.");
      }
    }
  }

  async function editarCliente(id) {
    const nome = prompt("Novo nome:");
    const idade = prompt("Nova idade:");
    const cpf = prompt("Novo CPF (11 dígitos):");
    const renda = prompt("Nova renda:");
    const local = prompt("Nova localização:");

    if (!nome || !idade || !cpf || !renda || !local) {
      alert("Todos os campos são obrigatórios!");
      return;
    }

    const resp = await fetch(`/clientes/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        name: nome,
        age: parseInt(idade),
        cpf: cpf,
        income: parseFloat(renda),
        location: local
      })
    });

    if (resp.ok) {
      alert("Cliente atualizado!");
      location.reload();
    } else {
      alert("Erro ao atualizar cliente.");
    }
  }
</script>

<%- include('partials/footer') %>
